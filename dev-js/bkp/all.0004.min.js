function ltrim(b){var a=0;while(a<b.length&&b[a]==" "){a++}return b.substring(a,b.length)}function rtrim(a){var b=a.length-1;while(b>0&&a[b]==" "){b-=1}return a.substring(0,b+1)}function utf8_decode(a){var c=[],e=0,g=0,f=0,d=0,b=0;a+="";while(e<a.length){f=a.charCodeAt(e);if(f<128){c[g++]=String.fromCharCode(f);e++}else{if(f>191&&f<224){d=a.charCodeAt(e+1);c[g++]=String.fromCharCode(((f&31)<<6)|(d&63));e+=2}else{d=a.charCodeAt(e+1);b=a.charCodeAt(e+2);c[g++]=String.fromCharCode(((f&15)<<12)|((d&63)<<6)|(b&63));e+=3}}}return c.join("")}var Encoding={utf8_decode:function(a){return utf8_decode(a)},trim:function(a){return rtrim(ltrim(a))}};window.log=function(){log.history=log.history||[];log.history.push(arguments);arguments.callee=arguments.callee.caller;if(this.console&&jsenv=="dev"){console.log(Array.prototype.slice.call(arguments))}};(function(e){function h(){}for(var g="assert,count,debug,dir,dirxml,error,exception,group,groupCollapsed,groupEnd,info,log,markTimeline,profile,profileEnd,time,timeEnd,trace,warn".split(","),f;f=g.pop();){e[f]=e[f]||h}})(window.console=window.console||{});var appContext="/demo-one-page-app";var BBModel=Backbone.Model,BBColl=Backbone.Collection,BBView=Backbone.View;window.APP={};APP.Events={};_.extend(APP.Events,Backbone.Events);var MagicMaps=new function(){var d=this;var e,b="http://clients.wpointstudio.com/happyplaces/images/marker.png";this.initialize=function(g){var f=document.getElementById("map"),h=new google.maps.LatLng(-34.604495,-58.396883);e=new google.maps.Map(f,{center:h,zoom:14,mapTypeId:google.maps.MapTypeId.ROADMAP,disableDefaultUI:false});if(!(!!g)){google.maps.event.addListenerOnce(e,"tilesloaded",a)}else{google.maps.event.addListenerOnce(e,"tilesloaded",c)}};this.showPlace=function(f,g){return function(k){d.resetMarker();var h='<div id="tooltip"><h3>Happy Place</h3><p>Direcci&oacute;n 1234, Buenos Aires</p><div><span class="likes">'+f+'</span><span class="friends">'+g+"</span></div></div>",l=new google.maps.LatLngBounds(),i=16,j=new google.maps.LatLng(this.position.lat(),this.position.lng()+(0.00008*i));l.extend(this.position);d.customInfo(l,h);e.setCenter(j);e.setZoom(i)}};this.customInfo=function(g,f){this.prototype=new google.maps.OverlayView();this.prototype.bounds_=g;this.prototype.html_=f;this.prototype.map_=e;this.prototype.div_=null;this.prototype.setMap(e);this.prototype.onAdd=function(){var i=document.createElement("DIV");i.style.borderStyle="none";i.style.borderWidth="0px";i.style.position="absolute";i.id="storeInfoOpen";i.innerHTML=this.html_;this.div_=i;var h=this.getPanes();h.overlayImage.appendChild(i)};this.prototype.draw=function(){var i=this.getProjection();var h=i.fromLatLngToDivPixel(this.bounds_.getSouthWest());var j=i.fromLatLngToDivPixel(this.bounds_.getNorthEast());var k=this.div_;k.style.left=(h.x-90)+"px";k.style.top=(j.y-143)+"px"};this.prototype.onRemove=function(){this.div_.parentNode.removeChild(this.div_);this.div_=null}};this.resetMarker=function(){$("#tooltip").remove()};var a=function(){var f=e.getBounds(),g=f.getSouthWest(),h=f.getNorthEast(),o=(h.lng()-g.lng())*3/4,l=h.lat()-g.lat(),k=new google.maps.MarkerImage(b,false,{x:0,y:0},{x:18,y:30});for(var n=0;n<10;n++){var j=new google.maps.LatLng(g.lat()+l*Math.random(),g.lng()+o*Math.random()),m=new google.maps.Marker({position:j,map:e,icon:k,shadow:"http://chart.apis.google.com/chart?chst=d_map_pin_shadow"});google.maps.event.addListener(m,"click",d.showPlace(Math.floor(Math.random()*99),Math.floor(Math.random()*98)))}};var c=function(){log("addRealMarkers!");var h=(UrlHelper.params.u)?UrlHelper.params.u:KO.userSession.nirvanaId,l=KO.Profiles.findById(h),n=new google.maps.MarkerImage(b,false,{x:0,y:0},{x:18,y:30});log(l);for(var k=0,j=l.places,f=j.length;k<f;k++){var m=new google.maps.LatLng(j[k].get("latitude"),j[k].get("longitude")),g=new google.maps.Marker({position:m,map:e,icon:n,shadow:"http://chart.apis.google.com/chart?chst=d_map_pin_shadow"})}}};window.UrlHelper=new function(){var g=location.href.split("/"),f=g[0],d=g[2],c=g[g.length-1];function b(j){var i=new Object();if(!!j){var h=j.split("=");i[h[0]]=h[1]}return i}function a(j){var m=new Object();for(var k=0,h=j.length;k<h;k++){var l=j[k].split("=");m[l[0]]=l[1]}return m}var e=(c.indexOf("?")>-1)?c.split("?")[0]:c.split("/")[c.split("/").length-1],e=(e!="")?e:"./";queryString=(c.indexOf("?")>-1)?c.split("?")[1]:"",variables=(!!queryString&&queryString.indexOf("&")>-1)?a(queryString.split("&")):b(queryString);this.params={};this.base="";this.page="";this.initialize=function(){this.page=e;this.params=variables;this.base=f+"//"+d}};UrlHelper.initialize();window.log=function(){log.history=log.history||[];log.history.push(arguments);arguments.callee=arguments.callee.caller;if(this.console){console.log(Array.prototype.slice.call(arguments))}};(function(e){function h(){}for(var g="assert,count,debug,dir,dirxml,error,exception,group,groupCollapsed,groupEnd,info,log,markTimeline,profile,profileEnd,time,timeEnd,trace,warn".split(","),f;f=g.pop();){e[f]=e[f]||h}})(window.console=window.console||{});APP.MenuModel=BBModel.extend({defaults:{title:"",recipes:[],created:null},initialize:function(){},validate:function(a){if(a.title==""){return"You have to set the name in the menu!"}},getAppetizer:function(){return this.get("recipes")[0]},getMainDish:function(){return this.get("recipes")[1]},getDessert:function(){return this.get("recipes")[2]},getCid:function(){return this.cid},getNiceDate:function(){var c=this.get("created"),b=c.date.split(" ")[0],d=b.split("-"),a={"01":"Enero","02":"Febrero","03":"Marzo","04":"Abril","05":"Mayo","06":"Junio","07":"Julio","08":"Agosto","09":"Septiembre","10":"Octubre","11":"Noviembre","12":"Diciembre"};return d[2]+" de "+a[d[1]]}});APP.RecipeModel=BBModel.extend({defaults:{name:"",url:"",type:"",menu:null},initialize:function(a){this.set({})},getUrlThumb:function(){var a=this.get("url")+"214x164.jpg";return a},getUrlBig:function(){var a=this.get("url")+"590x352.jpg";return a},validate:function(a){if(!a.type){return"This recipe needs a type!"}},clear:function(){this.destroy();this.view.remove()}});APP.MenuCollection=BBColl.extend({model:APP.MenuModel,url:function(){return(!this.menuId)?"/demo-rest-services/public_html/index.php/api/menus":"/demo-rest-services/public_html/index.php/api/menus/"+this.menuId},findByCreateDate:function(a){var c=this.models;var b=_.filter(c,function(d){var e=d.get("eventDate").journey.date.split(" ")[0];return e==a});return b},findByMenuId:function(c){var b=this.models;var a=_.find(b,function(d){return d.id==c});return a}});var menuCollection=new APP.MenuCollection();APP.RecipeCollection=BBColl.extend({model:APP.RecipeModel,url:function(){return(!this.recipeId)?"/demo-rest-services/public_html/index.php/api/recipes":"/demo-rest-services/public_html/index.php/api/recipes"+this.recipeId},findByRecipeId:function(c){var b=this.models;var a=_.find(b,function(d){return d.id===c});return a}});var recipeCollection=new APP.RecipeCollection();var $containerAlert=$("#alertContainer");var box={show:function(c){if(!!this.init){this.init()}$containerAlert.stop().hide();var b=this,a=b.$el;if(!!c){a.find("p").html(c)}a.stop().fadeIn();if(this.id!="loaderBox"){a.find("a.close").off("click").on("click",function(){b.hide()})}},hide:function(){this.$el.stop().fadeOut();$containerAlert.stop().fadeIn()}};var errorBox={id:"errorBox",$el:$("#errorBox"),};var alertBox={id:"alertBox",$el:$("#alertBox"),};var loaderBox={id:"loaderBox",$el:$("#loaderBox"),};var boxes={base:box,error:$.extend(errorBox,box),alert:$.extend(alertBox,box),loader:$.extend(loaderBox,box)};var Hero={hideAllBoxes:function(){$(".hero-unit .box").hide()},showWelcomeBox:function(){this.hideAllBoxes();$("#welcomeBox").fadeIn()},showCreateBox:function(){this.hideAllBoxes();$("#createBox").fadeIn()},showThanksBox:function(){this.hideAllBoxes();$("#thanksBox").fadeIn()}};var MidContent={hide:function(a){$(".mid-content").hide()},showList:function(a){this.hide();$("#menuList").fadeIn("normal",a)},showDetail:function(a){this.hide();$("#menuDetail").fadeIn("normal",a)}};var loader={singleMemory:{},allMenusMemory:{},recipes:{},singleItem:function(c,h){var a=c.view,e=c.viewArguments,f=c.collectionData;var d=h.coll,b=h.cache,g=h.actualPage;if(!b["page"+g]||(b["page"+g]&&d.refresh)){boxes.loader.show();recipeCollection.fetch({data:f,error:function(i){if(h.onError){h.onError(i)}if(e.url){window.location=e.url}boxes.loader.hide()},success:function(j,i){e.menuModels=b["page"+g]=j.models;a.render(e);boxes.loader.hide()}})}else{e.menuModels=b["page"+g];a.render(e)}},singlePaginatedAction:function(c,h){log("loader.singlePaginatedAction");var a=c.view,e=c.viewArguments,f=c.collectionData;var d=h.coll,b=h.cache,g=h.actualPage;if(!b["page"+g]||(b["page"+g]&&d.refresh)){boxes.loader.show();d.fetch({data:f,error:function(i){if(h.onError){h.onError(i)}if(e.url){window.location=e.url}boxes.loader.hide()},success:function(j,i){log("loader.singlePaginatedAction.success");e.menuModels=b["page"+g]=j.models;a.render(e);boxes.loader.hide()}})}else{e.menuModels=b["page"+g];a.render(e)}},randomRecipe:function(a,d){var c=d.type,b=this.recipes;boxes.loader.show();recipeCollection.fetch({data:d,success:function(f,e){d.recipe=f.models[0];var g=d.recipe.get("id");a.changeRecipe(d);b["recipe"+g]=d.recipe;boxes.loader.hide()}})},randomRecipesForCreateMenu:function(a){var b=this.recipes;boxes.loader.show();var c={};recipeCollection.fetch({data:{randomBy:"appetizer"},success:function(e,d){c.appetizer=e.models[0];var f=c.appetizer.get("id");b["recipe"+f]=c.appetizer;e.fetch({data:{randomBy:"main dish"},success:function(h,g){c.mainDish=h.models[0];var i=c.mainDish.get("id");b["recipe"+i]=c.mainDish;h.fetch({data:{randomBy:"dessert"},success:function(k,j){c.dessert=k.models[0];var l=c.dessert.get("id");b["recipe"+l]=c.dessert;a.render({recipes:c});boxes.loader.hide()}})}})}})},allMenus:function(a,c,e){log("loader.allMenus");var d=this.allMenusMemory,b={view:a,viewArguments:c,collectionData:e},f={coll:menuCollection,cache:d,actualPage:e.page};this.singlePaginatedAction(b,f)},menuById:function(a,d){var e=d.menuId,c=menuCollection,b=this.singleMemory;c.menuId=e;if(!b["menu"+e]){boxes.loader.show();c.fetch({success:function(g,f){d.menu=g.models[0];a.render(d);b["menu"+e]=d.video;boxes.loader.hide()}})}else{d.video=b["menu"+e];log(d.menu);a.render(d)}}};APP.MenuNewView=BBView.extend({el:$("#menuList"),template:_.template($("#menuNewTemplate").html()),getHtml:function(){var a={_:_,menu:this.model};return this.template(a)},render:function(){log("  APP.MenuNewView.render");var b={_:_,menu:this.model};var a=this.template(b);this.$el.prepend(a).slideDown();app_router.navigate("thankyou",{trigger:true})}});APP.MenuCreateView=BBView.extend({el:$("#appContainer .hero-unit"),template:_.template($("#menuCreateDishesTemplate").html()),events:{"click .refresh-btn":"refreshDish","submit #formCreate":"processCreation",},processCreation:function(){log("processing...");var f=$("#formCreate"),g=f.find(".input-large"),a=$("#createBox").find(".dishes article"),e=$(a[0]),c=$(a[1]),b=$(a[2]);if(g.val()==""){alert("You have to set the name in the menu!")}var d={title:g.val(),recipes:[{id:parseInt(e.attr("data-recipe-id")),url:e.attr("data-base-url")},{id:parseInt(c.attr("data-recipe-id")),url:c.attr("data-base-url")},{id:parseInt(b.attr("data-recipe-id")),url:b.attr("data-base-url")}]};this.menuCollection.create(d);return false},appendNewMenu:function(b){log("appendNewMenu");log(b);var a=new APP.MenuNewView({model:b});a.render()},refreshDish:function(c){c.preventDefault();c.stopPropagation();var a=$(c.currentTarget),b=a.data("type"),d=this;loader.randomRecipe(d,{randomBy:b})},initialize:function(){log("APP.MenuCreateView.init");this.recipeCollection=recipeCollection;this.menuCollection=menuCollection;this.menuCollection.on("add",this.appendNewMenu,this);this.menuCollection.on("error",function(b,a){if(jsenv==="dev"){$("#appContainer").html(a.responseText)}})},render:function(d){log("APP.MenuCreateView.render");$(".details").hide();this.$el.find(".input-large").val("");var c=d.recipes,b={_:_,recipes:c};var a=this.template(b);this.$el.find(".dishes").html(a);Hero.showCreateBox()},changeRecipe:function(c){if(c){var b=c.recipe.getUrlThumb(),a=c.recipe.get("id");switch(c.randomBy){case"appetizer":$(".dishes .appetizer").attr("data-recipe-id",a).find("img").attr("src",b);break;case"main dish":$(".dishes .main-dish").attr("data-recipe-id",a).find("img").attr("src",b);break;case"dessert":$(".dishes .dessert").attr("data-recipe-id",a).find("img").attr("src",b);break}}}});var menuCreateView=new APP.MenuCreateView;APP.MenuListView=BBView.extend({el:$("#menuList"),template:_.template($("#menuListTemplate").html()),events:{},initialize:function(){log("APP.MenuListView.init")},render:function(e){log("APP.MenuListView.render");$(".details").hide();var d=e.menuModels,b=$("#appContainer").data("menus-per-page");var c={_:_,menuModels:d};var a=this.template(c);this.$el.html(a)}});var menuListView=new APP.MenuListView();APP.MainView=BBView.extend({el:$("#appContainer"),events:{"click #loadMoreMenues":"loadMoreMenus","click #createAgainBtn":"showCreateBox",},loadMoreMenus:function(c){var b=parseInt($("#appContainer").data("allMenus-page"));var a="#menus/page/";window.location=a+(b+1)},showCreateBox:function(){app_router.navigate("create-menu",{trigger:true})},initialize:function(){log("APP.MainView.init");this.collection=menuCollection},render:function(c){log("APP.MainView.render");$(".details").show();var b=this.collection.models;var a={_:_,videosRanked:b};Hero.showWelcomeBox();MidContent.showList()}});var mainView=new APP.MainView();function updateClassContainer(a){$("#app-container").attr("class","container-fluid "+a)}var AppRouter=Backbone.Router.extend({routes:{"menu/:menuId":"showMenuById",menus:"showAllMenus","menus/":"showAllMenus","menus/page/:page":"showAllMenusByPage","create-menu":"menuCreateForm",thankyou:"thanksView","*actions":"defaultAction"},thanksView:function(){updateClassContainer("thankyou");Hero.showThanksBox();MidContent.showList()},menuCreateForm:function(){updateClassContainer("create-menu");loader.randomRecipesForCreateMenu(menuCreateView)},showMenuById:function(a){updateClassContainer("detail-menu");loader.menuById(menuDetailView,{menuId:a})},showAllMenus:function(){this.navigate("menus/page/1",{trigger:true})},showAllMenusByPage:function(a){updateClassContainer("all-menus");menusPerPage=$("#appContainer").data("menus-per-page");$("#appContainer").data({"allMenus-page":a});loader.allMenus(menuListView,{action:"allMenus",page:a,url:"#menus/page/1"},{page:a,maxResults:menusPerPage})},defaultAction:function(a){updateClassContainer("home");menusPerPage=$("#appContainer").data("menus-per-page");menuCollection.menuId=false;mainView.render();loader.allMenus(menuListView,{action:"home",page:1},{page:1,maxResults:menusPerPage,orderBy:"m.id"})}});var app_router=new AppRouter;$(function(){Backbone.history.start()});